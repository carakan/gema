<div class="breadcrumps">
  <%= link_to "Lista de importaciones", importaciones_path %> > <%= link_to "Cruce gaceta", cruce_importaciones_path(:importacion_id => params[:importacion_id], :page => @page) %> > Selección
</div>

<h1>"<%= @marca.nombre %>"</h1>

<p>
  <%= ver_cruce(@consulta, :class => 'ajax') unless params[:consulta_id].nil? %>
</p>

<a class="more" href="javascript:">Ver más</a>
<div class="hidden">
  <div class="half fl" id="div1">
    <p>
      <label>Clase:</label>
      <%= @marca.clase_id %>
    </p>
    <p>
      <label> Nº solicitud </label>
      <%= @marca.numero_solicitud %>
    </p>
    <p>
      <label>Nº publicación:</label>
      <%= @marca.numero_publicacion %>
    </p>
  </div>
  <div class="half fl" id="div2">
    <p>
      <label for="">Tipo: </label>
      <%= @marca.tipo_signo %>
    </p>
    <p>
      <label for="">Fecha solicitud</label>
      <%= lo @marca.estado_fecha %>
    </p>
    <p>
      <label>Titulares:</label>
      <%= @marca.titulares.join(", ") %>
    </p>
  </div>
  <%= link_to "Ver marca", ver_marca_path(@marca), :class => 'ajax show' %>
</div>

<h2 class="dark">Resultados del cruce</h2>

<%= semantic_form_for @con, :url => cruce_consultas_path do |f| -%>
  <%= f.input :consulta_id, :as => :hidden %>
  <%= f.input :busqueda, :as => :hidden, :as => :hidden %>
  <%= f.input :parametros, :as => :hidden, :input_html => { :value => f.object.parametros.to_yaml } %>
  <%= f.input :marca_id, :as => :hidden %>
  <%= f.input :importacion_id, :as => :hidden %>

  <%= hidden_field_tag "page", @page %>

  <%= f.input :comentario, :as => :text, :input_html => {:cols => 100} %>
  <p>
    <%= f.submit 'Salvar' unless @busqueda.blank? %>
    <%= f.submit 'Descartar cruce', :class => 'red' unless @busqueda.blank? %>
  </p>
  <% unless @busqueda.blank? %>

    <table class="decorated .nolink" id="tabla-cruce">
      <tr>
        <th></th>
        <th>Nombre</th>
        <th>Clase</th>
        <th>Tipo de<br/> busqueda</th>
        <th>Agentes</th>
        <th>Titulares</th>
      </tr>
      <% @busqueda.each_with_index do |b, i| %>
        <tr>
          <td>
            <%= check_box_tag "consulta[consulta_detalles_attributes][#{i}][marca_id]", b.id, @consulta_detalles.include?(b.id), 'data-tipo' => '' %>
          </td>
          <td>
            <label for="consulta_consulta_detalles_attributes_<%= i %>_marca_id" class="propia"><%= b.nombre %></label>
          </td>
          <td><%= b.clase_id %></td>
          <td><%= tipo_busqueda b.pos %></td>
          <td><%= buscar_representante(b.agente_ids_serial, @representantes) %></td>
          <td><%= buscar_representante(b.titular_ids_serial, @representantes) %></td>
        </tr>
      <% end %>

    </table>

  <% end %>

  <p>
    <%= f.submit 'Salvar' unless @busqueda.blank? %>
    <%= f.submit 'Descartar cruce', :class => 'red' unless @busqueda.blank? %>
  </p>
<% end %>


<script type="text/javascript">
  (function($) {

    function validarForma() {
      msg = "";
      if($('#consulta_comentario').val().trim() == "") {
        msg = "Debe ingresar un comentario";
      }
      if ( $('input:checkbox:checked').length <= 0 ) {
        msg = "Debe seleccionar al menos una marca";
      }
      return msg;
    }

    $('input:submit').click(function(e) {
      var target = e.target;
      if($(target).val() == "Salvar") {
        var msg = validarForma();
        if(msg != "") {
          alert(msg);
          return false;
        }
      }
    });
    // Adicion de un hidden para todos los elementos seleccioandos
    /*
    $('input:checkbox').click(function() {
      if( $(this).attr('checked') ) {
        var input = document.createElement('input');
        $(input).attr({
          'name': $(this).attr('name').replace(/marcas/, 'tipos'),
          'type': 'hidden',
          'value': $(this).attr('data-tipo')
        });
        $(this).after(input);
      }else {
        $(this).siblings('input:hidden').remove();
      }
    });
    */  
  })(jQuery);

</script>
