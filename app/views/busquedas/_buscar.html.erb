<form action="/busquedas" method="get" id="form_buscar" >
      <div style="clear:both"></div>
  <div style="clear:both"></div>
  <div class="half fl">
    <%= label_tag "busqueda", "Busqueda" %>
    <label for="busqueda"></label>
    <%= text_field_tag :busqueda, params[:busqueda], :size => 40 %>
  </div>
  <% if show_titulares %>
    <div class="half fl">
      Bucar por
      <label for="representante_agente">
        <%= check_box_tag "representante[]", "agente", params[:representante] ? params[:representante].include?("agente") : false, :id => "representante_agente" %> Agente
      </label>
      <label for="representante_titular">
        <%= check_box_tag "representante[]", "titular", params[:representante] ? params[:representante].include?("titular") : false, :id => "representante_titular" %> Titular
      </label>
      <%= hidden_field_tag 'representante_id', params[:representante_id] %>
      <%= text_field_tag "cliente", params[:cliente], :size => 40 %>
      <p class="hint">escriba para poder seleccionar el cliente</p>
    </div>
    <div class="clear"></div>
    <%= render :partial => "generic_select" %>
  <% end -%>
  <input type="submit" value="Buscar" />

</form>

<script type="text/javascript">
  $(document).ready(function() {
    $('input[name=tipo_busqueda]').click(function() {
      if( $(this).val() == 'prep' ) {
        $('#fechas').show();
      }else{
        $('#fechas').hide();
        $('#fechas input').val('');
      }
    });

    // Busca si existe el valor en el array
    function include(arr, obj) {
      for(var i=0; i<arr.length; i++) {
        if (arr[i] == obj) return true;
      }
      return false;
    }
    window.include = include;

    /**
     * Marca los botones que estan seleccionados
     */
    function marcarBotones() {
      var arr = $('#clases_grupos').find("input:checkbox:checked").map(function(i, el) { return el.value; }).get();

      $('#botones').find('a').each(function(i, el) {
        var clases = $(el).attr("data-clases").split(",");
        var encontrado = true;
        $(clases).each(function(index, elem) {
          if(!include(arr, elem)) {
            encontrado = false;
            return;
          }
        });
        if(encontrado) {
          $(el).addClass("sel");
        }else {
          $(el).removeClass("sel");
        }
      });
    }

    $('#botones').find("a").live('click', function() {
      var clases = $(this).attr("data-clases").split(",");
      var val = !$(this).hasClass("sel");

      $(clases).each(function(i, el) {
        $('#clases_' + el).attr("checked", val);
      });
      marcarBotones();
    });

    $('#clases_grupos').find("input:checkbox").live('click', function() {
      marcarBotones();
    });

    // Al iniciar
    marcarBotones();

    // Validacion para la busqueda
    $('#form_buscar').submit(function() {
      var txt = "";
      if($('#clases_grupos').find(':checkbox:checked').length <= 0) {
        txt += "Debe seleccionar al menos una clase para la busqueda\n";
      }
      if($('#busqueda').val().trim() == "") {
        txt += "Debe ingresar un termino de busqueda";
      }
      //if($('#representante_id').val().trim() == "") {
      //  txt += "Debe seleccionar un cliente";
      //}
      if(txt != ""){
        alert(txt);
        return false;
      }else{
        return true;
      }

    });

    //var clientes = <%= Representante.clientes.map { |v| { :id => v.id, :label => v.nombre } }.to_json.html_safe %>;

    // Clientes
    $('#cliente').autocomplete({
      'source': '/representantes/buscar',
      'select': function(e, ui) {
        var val = $(ui).autocomplete("option").get()[0];
        $('#representante_id').val(val.item.id);
        $('span.representante_id').html(val.item.label);
      }
    });

    $('#cliente').change(function(event){
      if($(this).val() == ""){
        $('#representante_id').val(null);
        $('span.representante_id').html("");
      }
    });
  });
</script>

